name: Verify branch rules

on:
  push:
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch required branches
        run: |
          git fetch origin path:path truth:truth

      - name: Verify repo state
        shell: bash
        run: |
          fail() {
            echo "❌ $1" >&2
            exit 1
          }

          for b in main path truth; do
            git show-ref --verify --quiet "refs/heads/$b" \
              || fail "Branch '$b' does not exist"
          done

          git show "path:path.txt" >/dev/null 2>&1 \
            || fail "Branch 'path' does not contain path.txt"

          git show "truth:truth.txt" >/dev/null 2>&1 \
            || fail "Branch 'truth' does not contain truth.txt"

          git merge-base --is-ancestor path main \
            || fail "'path' has not been merged into 'main'"

          git merge-base --is-ancestor truth main \
            || fail "'truth' has not been merged into 'main'"

          mb_path=$(git merge-base main path)
          mb_truth=$(git merge-base main truth)

          if git merge-base --is-ancestor "$mb_truth" "$mb_path"; then
            fail "'truth' was merged before 'path' (wrong order)"
          fi

          echo "✅ All checks passed"
